import time

import netifaces
from scapy.all import conf, srp
from scapy.layers.l2 import Ether, ARP


def mask_to_length(mask):
    m = [int(e) for e in mask.split('.')]
    length = 0

    for i in range(4):
        length += [0, 128, 192, 224, 240, 248, 252, 254, 255].index(m[i])

    return length


def main():
    ip = conf.route.route("0.0.0.0")[2]  # router IP using scapy config
    mask = None

    for _, interface in enumerate(netifaces.interfaces()):
        i = netifaces.ifaddresses(interface)

        # AF_INET references the IPv4 interface
        if netifaces.AF_INET in i:
            if i[netifaces.AF_INET][0]['addr'] != '127.0.0.1':
                # Get the network mask
                mask = i[netifaces.AF_INET][0]['netmask']

    if not ip or not mask:
        print("No IP or mask could be found.")
        exit(1)

    print("Starting to send packets...")
    t_start = time.time()

    # make a "super-packet", by giving the network CIDR to scapy
    # It will then send X packets, X being the number of addresses in the network
    pkt = Ether(dst="ff:ff:ff:ff:ff:ff") / ARP(pdst=f"{ip}/{mask_to_length(mask)}")

    # Send the packet
    ans, unans = srp(pkt, timeout=2, verbose=False, filter="arp and arp[7] = 2")

    # Loop through the answered packets
    for snt, recv in ans:
        if recv:
            print(f"{recv[ARP].psrc.ljust(16, ' ')}: {recv[Ether].src}")

    print("-----------------------------------------")
    print(f"Discovered network in {round(time.time() - t_start, 2)}s")
    print()


if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        exit(0)
