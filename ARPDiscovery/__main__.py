import time
from sys import argv

import netifaces
from scapy.all import conf, srp
from scapy.layers.l2 import Ether, ARP


# Returns the network and broadcast addresses for the network
def get_addresses(ip, mask):
    i = [int(e) for e in ip.split('.')]
    m = [int(e) for e in mask.split('.')]

    net_add = [i[b] & m[b] for b in range(4)]
    bct_add = [i[b] | (255 ^ m[b]) for b in range(4)]

    return net_add, bct_add


def main():
    try:
        printall = argv[1] == 'true' or argv[1] == '1'
    except IndexError:
        printall = False

    ip = conf.route.route("0.0.0.0")[2]  # router IP using scapy config
    mask = None

    for _, interface in enumerate(netifaces.interfaces()):
        i = netifaces.ifaddresses(interface)

        # AF_INET references the IPv4 interface
        if netifaces.AF_INET in i:
            if i[netifaces.AF_INET][0]['addr'] != '127.0.0.1':
                # Get the network mask
                mask = i[netifaces.AF_INET][0]['netmask']

    if not ip or not mask:
        print("No IP or mask could be found.")
        exit(1)

    s, e = get_addresses(ip, mask)

    print("Starting to send packets...")
    t_start = time.time()

    for i in range(e[0]-s[0]+1):
        for j in range(e[1]-s[1]+1):
            for k in range(e[2]-s[2]+1):
                for m in range(1, e[3]-s[3]):  # Avoid sending on the net and bct adresses
                    current = f"{s[0]+i}.{s[1]+j}.{s[2]+k}.{s[3]+m}"  # make the IP string from the integers

                    pkt = Ether(dst="ff:ff:ff:ff:ff:ff") / ARP(pdst=current)

                    # Send the packet with a small timeout
                    ans, unans = srp(pkt, timeout=0.2, verbose=False)

                    # The two for loops below are exclusive, because one packet is EITHER answered or not answered.
                    # I still used for loops to demonstrate how you can easily do it on greater numbers of packets

                    # Loop through the answered packets (should only be one, because we only sent one)
                    for snt, recv in ans:
                        if recv:
                            print(f"{recv[ARP].psrc}: awake - {recv[Ether].src}")
                    # Loop through the unanswered packets (should also only be one)
                    if printall:
                        for snt in unans:
                            print(f"{snt[ARP].pdst}: unkwown")

    print("-----------------------------------------")
    print(f"Sent all packets. {round(time.time() - t_start, 2)}s")
    print()


if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        exit(0)
